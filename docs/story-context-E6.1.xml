<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>E6</epicId>
    <storyId>E6.1</storyId>
    <title>Geofence Definition</title>
    <status>Draft</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/martinjanci/cursor/phone-manager/docs/stories/story-E6.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to define geofence zones</iWant>
    <soThat>I get alerts for specific places</soThat>
    <tasks>
      <task id="1" acs="E6.1.1, E6.1.2">Create Geofence Domain Model</task>
      <task id="2" acs="E6.1.1">Create Geofence Room Entity</task>
      <task id="3" acs="E6.1.4">Create Network Models</task>
      <task id="4" acs="E6.1.4">Create GeofenceRepository</task>
      <task id="5" acs="E6.1.3">Implement Android Geofencing Registration</task>
      <task id="6" acs="E6.1.5">Create GeofencesScreen UI</task>
      <task id="7" acs="E6.1.6">Create CreateGeofenceScreen</task>
      <task id="8" acs="E6.1.5">Create GeofencesViewModel</task>
      <task id="9" acs="All">Testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="E6.1.1">
      <title>Geofence Entity</title>
      <given>the data model is defined</given>
      <then>Geofence entity should include: id (UUID), deviceId (owner device), name (e.g., "Home", "Office"), latitude, longitude (center point), radiusMeters, transitionTypes (ENTER, EXIT, DWELL set), webhookId (optional link to webhook), active (Boolean), createdAt, updatedAt</then>
    </ac>
    <ac id="E6.1.2">
      <title>Transition Types</title>
      <given>I am creating a geofence</given>
      <when>I select transition types</when>
      <then>I should be able to choose any combination of: ENTER (trigger when entering zone), EXIT (trigger when leaving zone), DWELL (trigger after staying in zone for duration)</then>
    </ac>
    <ac id="E6.1.3">
      <title>Android Geofencing API Registration</title>
      <given>I create or enable a geofence</given>
      <when>the geofence is saved</when>
      <then>it should be registered with Android Geofencing API</then>
      <and>use GeofencingClient.addGeofences()</and>
    </ac>
    <ac id="E6.1.4">
      <title>Server Sync</title>
      <given>I create a geofence</given>
      <when>I save</when>
      <then>it should sync to server via POST /api/geofences</then>
      <and>persist across app reinstalls</and>
    </ac>
    <ac id="E6.1.5">
      <title>Geofence Management UI</title>
      <given>I am on the Geofences screen</given>
      <then>I should be able to: view list of my geofences, create new geofence, edit existing geofence, delete geofence, enable/disable geofence</then>
    </ac>
    <ac id="E6.1.6">
      <title>Map-Based Location Selection</title>
      <given>I am creating a geofence</given>
      <when>I set the location</when>
      <then>I should be able to: select location by tapping on map, enter coordinates manually, use current location as center</then>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd-phone-manager-2025-11-25.md</path>
        <title>Product Requirements Document - Feature 5: Geofencing with Webhooks</title>
        <section>FR-5.1 Geofence Definition</section>
        <snippet>FR-5.1.1: System SHALL allow creating geofences with: name, latitude, longitude, radiusMeters (Must Have)
FR-5.1.2: System SHALL support transition types: ENTER, EXIT, DWELL (Must Have)
FR-5.1.3: System SHALL register geofences with Android Geofencing API (Must Have)
FR-5.1.4: System SHALL store geofences on server for sync and management (Must Have)</snippet>
      </doc>
      <doc>
        <path>docs/prd-phone-manager-2025-11-25.md</path>
        <title>Product Requirements Document - Data Model: Geofence</title>
        <section>Section 5 - Feature 5</section>
        <snippet>data class Geofence(
    val id: String,
    val deviceId: String,
    val name: String,
    val latitude: Double,
    val longitude: Double,
    val radiusMeters: Int,
    val transitionTypes: Set&lt;TransitionType&gt;, // ENTER, EXIT, DWELL
    val webhookId: String?,
    val active: Boolean,
    val createdAt: Instant,
    val updatedAt: Instant
)
enum class TransitionType { ENTER, EXIT, DWELL }</snippet>
      </doc>
      <doc>
        <path>docs/prd-phone-manager-2025-11-25.md</path>
        <title>API Specification - POST /api/geofences</title>
        <section>Section 6 - API Specifications</section>
        <snippet>Request: { "deviceId": "device-001", "name": "Home", "latitude": 48.1486, "longitude": 17.1077, "radiusMeters": 100, "transitionTypes": ["ENTER", "EXIT"], "webhookId": "webhook-001", "active": true }</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 6: Geofencing with Webhooks - Story 6.1</title>
        <section>Story 6.1: Geofence Definition</section>
        <snippet>User Story: As a user, I want to define geofence zones so that I get alerts for specific places
Acceptance Criteria:
- Create Geofence entity with name, lat/lon, radiusMeters, transitionTypes
- Support ENTER, EXIT, DWELL transition types (any combination)
- Register with Android Geofencing API
- Sync to server via POST /api/geofences
- UI for CRUD operations and map-based location selection</snippet>
      </doc>
      <doc>
        <path>docs/solution-architecture.md</path>
        <title>Solution Architecture - Repository Pattern</title>
        <section>ADR-005: Room Database</section>
        <snippet>Repository pattern isolates data sources from ViewModels. Room database used for type-safe SQL queries with compile-time verification. Multiple data sources: Location API, Network, Database, Preferences.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/data/repository/DeviceRepository.kt</path>
        <kind>repository-pattern</kind>
        <symbol>DeviceRepository, DeviceRepositoryImpl</symbol>
        <lines>18-106</lines>
        <reason>Reference pattern for creating GeofenceRepository - shows repository interface, implementation with network sync, local storage, and error handling</reason>
      </artifact>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/data/database/AppDatabase.kt</path>
        <kind>database</kind>
        <symbol>AppDatabase</symbol>
        <lines>13-28</lines>
        <reason>Must add GeofenceEntity to entities list and provide geofenceDao() method</reason>
      </artifact>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/data/database/LocationDao.kt</path>
        <kind>dao-pattern</kind>
        <symbol>LocationDao</symbol>
        <lines>13-41</lines>
        <reason>Reference pattern for creating GeofenceDao - demonstrates Room DAO structure with suspend functions and Flow</reason>
      </artifact>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/network/DeviceApiService.kt</path>
        <kind>api-service-pattern</kind>
        <symbol>DeviceApiService, DeviceApiServiceImpl</symbol>
        <lines>26-78</lines>
        <reason>Reference pattern for creating GeofenceApiService - demonstrates Ktor HTTP client usage with proper headers and Result wrapping</reason>
      </artifact>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/security/SecureStorage.kt</path>
        <kind>storage-utility</kind>
        <symbol>SecureStorage.getDeviceId()</symbol>
        <lines>N/A</lines>
        <reason>Required to get deviceId when creating geofences</reason>
      </artifact>
      <artifact>
        <path>app/src/main/java/three/two/bit/phonemanager/location/LocationManager.kt</path>
        <kind>location-utility</kind>
        <symbol>LocationManager.getCurrentLocation()</symbol>
        <lines>49-76</lines>
        <reason>Required for "use current location as center" feature in CreateGeofenceScreen</reason>
      </artifact>
    </code>
    <dependencies>
      <android>
        <androidx-room version="2.8.4">Room database for GeofenceEntity and GeofenceDao</androidx-room>
        <androidx-lifecycle version="2.10.0">ViewModels for GeofencesViewModel</androidx-lifecycle>
        <androidx-compose-bom version="2025.10.01">Jetpack Compose UI for GeofencesScreen and CreateGeofenceScreen</androidx-compose-bom>
        <androidx-navigation version="2.9.6">Navigation Compose for screen routing</androidx-navigation>
        <androidx-hilt version="1.3.0">Hilt navigation compose integration</androidx-hilt>
        <play-services-location version="21.3.0">Google Play Services Location for GeofencingClient API</play-services-location>
        <maps-compose version="latest">Google Maps Compose for map-based location selection</maps-compose>
      </android>
      <networking>
        <ktor version="3.3.2">HTTP client for GeofenceApiService</ktor>
      </networking>
      <di>
        <hilt version="2.57.2">Dependency injection for GeofenceRepository, GeofenceApiService, GeofenceManager, GeofencesViewModel</hilt>
      </di>
      <kotlin>
        <kotlinx-datetime version="0.6.1">Instant timestamps for createdAt, updatedAt</kotlinx-datetime>
        <kotlinx-coroutines version="1.10.2">Coroutines for suspend functions and Flow</kotlinx-coroutines>
        <kotlinx-serialization version="1.9.0">JSON serialization for API DTOs</kotlinx-serialization>
      </kotlin>
      <logging>
        <timber version="5.0.1">Debug and error logging</timber>
      </logging>
      <testing>
        <junit version="4.13.2">Unit testing framework</junit>
        <mockk version="1.14.6">Mocking library for GeofenceRepository and GeofencesViewModel tests</mockk>
        <kotlin-test version="2.2.21">Kotlin test assertions</kotlin-test>
        <kotlinx-coroutines-test version="1.10.2">Coroutine testing support</kotlinx-coroutines-test>
      </testing>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow Repository pattern with local + remote sync strategy (see DeviceRepository)</constraint>
    <constraint>Use Room database for offline support and data persistence</constraint>
    <constraint>Sync strategy: remote-first on startup, optimistic local updates</constraint>
    <constraint>Network availability check before API calls (use NetworkManager)</constraint>
    <constraint>Wrap API responses in Result type for error handling</constraint>
    <constraint>Use Ktor HttpClient for HTTP requests with X-API-Key header</constraint>
    <constraint>Store transitionTypes as comma-separated String in Room entity (e.g., "ENTER,EXIT,DWELL")</constraint>
    <constraint>Use kotlinx.datetime.Instant for timestamps</constraint>
    <constraint>Apply Timber logging for debug/error messages</constraint>
    <constraint>Follow existing package structure: domain/model/, data/model/, data/database/dao/, network/, geofence/</constraint>
    <constraint>Use Hilt @Inject and @Singleton for dependency injection</constraint>
    <constraint>Unit tests require >80% coverage using MockK for mocking</constraint>
    <constraint>Android Geofencing API requires ACCESS_FINE_LOCATION and ACCESS_BACKGROUND_LOCATION permissions</constraint>
    <constraint>GeofencingClient.addGeofences() requires @SuppressLint("MissingPermission") when permissions verified</constraint>
    <constraint>Create GeofenceManager wrapper around GeofencingClient for testability</constraint>
    <constraint>Use suspendCoroutine for Task-based GeofencingClient API conversion to coroutines</constraint>
    <constraint>Map-based location selection requires Google Maps SDK integration</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>SecureStorage.getDeviceId()</name>
      <kind>storage-method</kind>
      <signature>fun getDeviceId(): String</signature>
      <path>app/src/main/java/three/two/bit/phonemanager/security/SecureStorage.kt</path>
      <reason>Required to get deviceId when creating geofences</reason>
    </interface>
    <interface>
      <name>NetworkManager.isNetworkAvailable()</name>
      <kind>utility-method</kind>
      <signature>fun isNetworkAvailable(): Boolean</signature>
      <path>app/src/main/java/three/two/bit/phonemanager/network/NetworkManager.kt</path>
      <reason>Required to check network before API sync operations</reason>
    </interface>
    <interface>
      <name>LocationManager.getCurrentLocation()</name>
      <kind>location-method</kind>
      <signature>suspend fun getCurrentLocation(): Result&lt;LocationEntity?&gt;</signature>
      <path>app/src/main/java/three/two/bit/phonemanager/location/LocationManager.kt:49</path>
      <reason>Required for "use current location as center" feature in CreateGeofenceScreen</reason>
    </interface>
    <interface>
      <name>ApiConfiguration</name>
      <kind>config-class</kind>
      <signature>data class ApiConfiguration(val baseUrl: String, val apiKey: String)</signature>
      <path>app/src/main/java/three/two/bit/phonemanager/network/ApiConfiguration.kt</path>
      <reason>Required for GeofenceApiService to access API endpoint base URL and authentication</reason>
    </interface>
    <interface>
      <name>GeofencingClient (Android API)</name>
      <kind>android-api</kind>
      <signature>com.google.android.gms.location.GeofencingClient</signature>
      <path>com.google.android.gms:play-services-location</path>
      <reason>Required for registering geofences with Android Geofencing API (addGeofences, removeGeofences)</reason>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Unit tests use JUnit 4 with MockK for mocking. Tests follow Given-When-Then structure with descriptive names using backticks. Coroutine tests use runTest from kotlinx-coroutines-test. Target coverage: &gt;80% for repositories, ViewModels, and GeofenceManager. Tests are located in app/src/test/java mirroring the main source structure. Use turbine for Flow testing when needed. GeofencingClient mocked for GeofenceManager tests.
    </standards>
    <locations>
      <location>app/src/test/java/three/two/bit/phonemanager/data/repository/</location>
      <location>app/src/test/java/three/two/bit/phonemanager/ui/geofences/</location>
      <location>app/src/test/java/three/two/bit/phonemanager/geofence/</location>
      <location>app/src/test/java/three/two/bit/phonemanager/domain/model/</location>
    </locations>
    <ideas>
      <idea ac="E6.1.1">Test Geofence data class instantiation with all required fields</idea>
      <idea ac="E6.1.1">Test Geofence validates radiusMeters within acceptable range</idea>
      <idea ac="E6.1.2">Test TransitionType enum has ENTER, EXIT, DWELL values</idea>
      <idea ac="E6.1.2">Test Geofence transitionTypes can be any combination of transition types</idea>
      <idea ac="E6.1.3">Test GeofenceManager.addGeofence() successfully registers with GeofencingClient</idea>
      <idea ac="E6.1.3">Test GeofenceManager.addGeofence() handles GeofencingClient failures gracefully</idea>
      <idea ac="E6.1.3">Test GeofenceManager.removeGeofence() unregisters from GeofencingClient</idea>
      <idea ac="E6.1.3">Test GeofenceManager maps TransitionType enum to Android Geofence transition flags correctly</idea>
      <idea ac="E6.1.4">Test GeofenceRepository.createGeofence() syncs to server via POST /api/geofences</idea>
      <idea ac="E6.1.4">Test GeofenceRepository.createGeofence() stores locally in Room database</idea>
      <idea ac="E6.1.4">Test GeofenceRepository.createGeofence() fails gracefully when network unavailable</idea>
      <idea ac="E6.1.4">Test GeofenceRepository.syncGeofences() fetches from server on startup</idea>
      <idea ac="E6.1.5">Test GeofencesViewModel loads geofences from repository on init</idea>
      <idea ac="E6.1.5">Test GeofencesViewModel.createGeofence() delegates to repository and triggers Android registration</idea>
      <idea ac="E6.1.5">Test GeofencesViewModel.deleteGeofence() removes from repository and unregisters from Android</idea>
      <idea ac="E6.1.5">Test GeofencesViewModel.toggleGeofence() enables/disables geofence and updates registration</idea>
      <idea ac="E6.1.6">Test CreateGeofenceScreen allows manual coordinate input</idea>
      <idea ac="E6.1.6">Test CreateGeofenceScreen uses current location when "Use Current Location" tapped</idea>
    </ideas>
  </tests>
</story-context>
